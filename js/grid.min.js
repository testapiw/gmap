"use strict";function initMap(){google.maps}!function(a,b){$(document).ready(function(){return google?void b({center:[50.435286,30.574576]}).createGrid(40,40).loadData("js/new2.json").setDataStyle().testGrid():!1})}({},function(a){function b(){for(var a=v.length;a--;)H[v[a]]=document.getElementById(v[a])}function c(a,b,c){var d,e,f,g=b,h=a,i=c||{north:50.62855,south:50.2086,west:30.22888,east:30.83828},j=i.west,k=i.south,l=(i.east-j)/b,m=(i.north-k)/a,n=[],o=[];for(g++;g--;)e=l*g+j,d=g%2===0,n[n.length]={lat:i[d?"north":"south"],lng:e},n[n.length]={lat:i[d?"south":"north"],lng:e};for(h++;h--;)f=m*h+k,d=h%2===0,o[o.length]={lat:f,lng:i[d?"west":"east"]},o[o.length]={lat:f,lng:i[d?"east":"west"]};return n=n.concat(o),A&&A.setMap(null),A=new I.Polyline({path:n,strokeColor:"#888877",strokeOpacity:1,strokeWeight:1,map:t}),this}function d(){B[B.hasClass("active")?"removeClass":"addClass"]("active")}function e(a){var b=p(a.latLng);H.nlat.value=b.lat[0],H.slng.value=b.lng[0]}function f(a,b){D.close(),D.setContent(a),D.setPosition(b),D.open(t)}function g(a){var b=(a.steps.length,a.distance);H.wrapperinfo.innerHTML="distance: ~"+b.text+"  <i>("+b.value+" м)</i><br/> duration: "+a.duration.text+'<br/><br/><img src="'+h({sumbol:"A",scale:"0.5"})+'"/>'+a.start_address+'<br/><br/><img src="'+h({sumbol:"B",scale:"0.5"})+'"/>'+a.end_address}function h(a){return"https://mts.googleapis.com/maps/vt/icon/name=icons/spotlight/spotlight-waypoint-{{a}}.png&text={{sumbol}}&psize=16&font=fonts/Roboto-Regular.ttf&color=ff333333&ax=44&ay=48&scale={{scale}}".replace("{{a}}",(a.sumbol||"").toLowerCase()).replace("{{sumbol}}",a.sumbol||"").replace("{{scale}}",a.scale||"1")}function i(a,b,c){return new I.MarkerImage(a,null,null,new I.Point(b,c))}function j(a,b){var c=a+"Feature";b||t.get(c);t.data.revertStyle(b),t.set(c,null)}function k(a,b){t.set(a+"Feature",b),u.overrideStyle(b,{icon:w[/[aA]/.test(a)?"start":"end"],zIndex:10})}function l(a){a&&(d(),E.geocode({address:a},function(a,b){b===I.GeocoderStatus.OK?(t.setCenter(a[0].geometry.location),C.setPosition(a[0].geometry.location)):console.log("Geocode was not successful for the following reason: "+b),d()}))}function m(a,b,c){var e,f=t.get(a+"Feature"),g=t.get(b+"Feature");f&&g&&(d(),n(f.getProperty("id").split(","),g.getProperty("id").split(",")),e={origin:f.getGeometry().get(),destination:g.getGeometry().get(),travelMode:I.DirectionsTravelMode[["DRIVING","BICYCLING","TRANSIT","WALKING"][c||0]]},G.route(e,function(a,b){b===I.DirectionsStatus.OK&&(console.log("createPath OK",a),F.setDirections(a),F.setMap(t)),d()}))}function n(a,b,c){if(a.length&&b.length){var d=new $.Deferred;return $.ajax({type:"GET",dataType:"json",url:"http://donkihot.xyz/tx_rdsh/ask_distance_from_matrix.php",crossDomain:!0,data:{row1:a[1].trim(),column1:a[0].trim(),row2:b[1].trim(),column2:b[0].trim()},success:function(a,b,e){H.dispanceDB.innerHTML="["+a+"]","function"==typeof c&&c(a),d.resolve(a)},error:function(a,b,c){H.dispanceDB.innerHTML="[no value]",console.warn(a,b,c)}}),d.promise()}}function o(a){return"[object Array]"===M.call(a)}function p(a){function b(a){var b=Math.abs(Math.round(1e5*a)),c=b/1e5,d=60*(c-Math.floor(c)),e=Math.floor(d);return[a,(0>a?"-":"")+Math.floor(c),e,60*Math.floor(1e5*(d-e))/1e5]}return{lat:b(a.lat()),lng:b(a.lng())}}function q(a){var b=a.target.id;$.inArray(b,v)&&"function"==typeof N[b]&&N[b]()}function r(a){a&&(u=a,u.addListener("mouseup",O.mouseup),u.addListener("click",O.click),u.addListener("mouseover",O.mouseover),u.addListener("mouseout",O.mouseout))}function s(a){var b;this.pull=[],b=this.pull,this.idx=[],this.d=[],a&&this.data(a)}var t,u,v,w,x,y,z,A,B,C,D,E,F,G,H={},I=google.maps,J=I.event,K=I.Marker,L=(I.Point,I.InfoWindow),M=Object.prototype.toString;v=["menu","crgrid","clear","map","glat","glng","nlat","slng","iddot","directions_panel","wrapperinfo","origin","destination","address","machine","dispanceDB"],b(),t=new I.Map(H.map,{center:{lat:a.center[0],lng:a.center[1]},zoom:12,mapTypeId:I.MapTypeId.ROADMAP}),E=new I.Geocoder,C=new I.Marker({animation:I.Animation.DROP,map:t}),D=new L({pixelOffset:new I.Size(0,-30)}),G=new I.DirectionsService,F=new I.DirectionsRenderer({preserveViewport:!0,draggable:!0,suppressMarkers:!0}),w={start:i(h({sumbol:"A"}),10,40),end:i(h({sumbol:"B"}),10,40)},x={green:"img/green.png",red:"img/red.png"},z={draggable:!0,zIndex:10,icon:{path:I.SymbolPath.CIRCLE,scale:4,fillColor:"gray",fillOpacity:.5,strokeWeight:1,strokeColor:"#FF0000",strokeOpacity:.5}},B=$(".loader");var N={crgrid:function(){var a=(H.glat.value||"").replace(/[^0-9]/g,""),b=(H.glng.value||"").replace(/[^0-9]/g,"");a&&b&&c(Math.abs(a),Math.abs(b))},address:function(){var a=H.origin.value;a&&l("Київ, "+a)},clearpath:function(){F.setMap(null),j("A"),j("B")},machine:function(){y&&y instanceof s&&y.load("http://donkihot.xyz/tx_rdsh/ask_taxi_position.php",y.update)}},O={mouseup:function(a){e(a),m("A","B")},click:function(a){var b=t.get("AFeature"),c=t.get("BFeature");b&&b===a.feature?j("A",a.feature):b&&!c?k("B",a.feature):b||c===a.feature?c&&c===a.feature&&j("B",a.feature):k("A",a.feature),m("A","B")},mouseover:function(a){t.get("AFeature")!==a.feature&&t.get("BFeature")!==a.feature&&(z.icon.fillColor="green",z.icon.strokeWeight=2,z.icon.scale=5,u.overrideStyle(a.feature,z)),f(a.feature.getProperty("id"),a.latLng)},mouseout:function(a){t.get("AFeature")!==a.feature&&t.get("BFeature")!==a.feature&&u.revertStyle(a.feature)}};return J.addDomListener(H.menu,"click",q),J.addListener(t,"click",e),J.addListener(F,"directions_changed",function(){g(F.directions.routes[0].legs[0])}),s.prototype.load=function(a,b){var c=this;return"string"!=typeof a?this:void $.ajax({type:"GET",dataType:"json",crossDomain:!0,url:a,data:{cabno:"ALL"},success:function(a,d,e){a&&o(a[0])&&("function"==typeof b?b.call(c,a):c.data(a))},error:function(a,b,c){console.log("error",a)}})},s.prototype.data=function(a){var b,c,d,e,f=0;for(e=a.length;e>f;f++)o(a[f])&&(d=this.getkey(a[f][0]),this.d[d]=a[f],c=this.gmkinfo(d),b=new K({map:t,icon:c.icon,position:c.latlng}),b.info=new L({content:c.content}),b.addListener("click",this.setgmk.bind(this,d,b,!0)),this.pull[d]=b)},s.prototype.getkey=function(a){var b=this.d.length,c=this.idx[a];return void 0!==c?c:(this.idx[a]=b,b)},s.prototype.setgmk=function(a,b,c){var d=this.gmkinfo(a);return c?b.info.open(t,b):(b.setIcon(d.icon),b.setPosition(d.latlng),b.info.setContent(d.content)),b},s.prototype.gmkinfo=function(a){return{latlng:{lat:this.d[a][1],lng:this.d[a][2]},content:"id:"+this.d[a][0]+", place:"+this.d[a][3],icon:this.d[a][3]>0?x.green:x.red}},s.prototype.update=function(a){var b,c,d=[];if(!a||!this.d)return this;for(c=a.length,d=this.d.map(function(a){return a[0]});c--;)b=this.idx[a[c][0]],void 0!==b?(this.d[b]=a[c],this.setgmk(b,this.pull[b]),d.splice(b,1)):this.data([a[c]]);this.clear(d)},s.prototype.enter=function(a){return a?(this.clear(),void this.data(a)):this},s.prototype.clear=function(a){var b,c,d;if(void 0!==a)for(o(a)||(a=[a]),d=a.length;d--;)b=this.idx[a[d]],this.removeListener(a[d]),this.pull[b].setMap(null),this.d.splice(b,1),this.pull.splice(b,1),this.idx.splice(a[d],1);else{for(this.removeListener(),this.d=[],this.idx=[],c=this.pull.length;c--;)this.pull[c].setMap(null);this.pull=[]}},s.prototype.removeListener=function(a){var b,c;if(void 0!==a)b=this.idx[a],J.clearInstanceListeners(this.pull[b]);else for(c=this.d.length;c--;)J.clearInstanceListeners(this.pull[c])},{loadData:function(a){return/file:/.test(window.location.protocol)?t.data.addGeoJson(localeData):t.data.loadGeoJson(a),r(t.data),this},setDataStyle:function(a){return t.data.setStyle({draggable:!0,zIndex:10,icon:{path:I.SymbolPath.CIRCLE,scale:4,fillColor:"gray",fillOpacity:.5,strokeWeight:1,strokeColor:"#FF0000",strokeOpacity:.5}}),this},createGrid:c,testGrid:function(){y=new s,y.load("http://donkihot.xyz/tx_rdsh/ask_taxi_position.php")},calcsm:p}});